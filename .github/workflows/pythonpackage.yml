name: Python package

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        py27:
          python.version: '2.7'
          tox.env: py27
        py35:
          python.version: '3.5'
          tox.env: py35
        py37:
          python.version: '3.7'
          tox.env: py37

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
    - name: Test with tox -e $(python.version)
      run: |
        tox -e $(tox.env)
    - name: Report Coverage
      env:
        CODECOV_TOKEN: $(codecov.token)
      run: |
          if [ ! -f .coverage.* ]; then
            echo No coverage data found.
            exit 0
          fi

          # codecov shells out to "coverage" and avoiding 'sudo pip' allows for
          # package caching.
          PATH=$HOME/.local/bin:$PATH

          case "$(python.version)" in
          "pypy2") PY=pypy ;;
          "pypy3") PY=pypy3 ;;
          *) PY=python$(python.version) ;;
          esac

          $PY -m pip install --user 'coverage[toml]' codecov

          coverage combine
          codecov
